{% extends "base.html" %}
{% block content %}
<style>
body { font-family: "Poppins", sans-serif; background-color: #f7f9fb; padding: 40px; color: black; }
h1,h2,h3,p,a,button,td,th { color: black; }
.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
.card { background: #fff; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); text-align: center; padding: 25px; cursor: pointer; transition: transform 0.3s, background 0.3s; font-weight: 600; }
.card:hover { background: #ffb6c1; transform: scale(1.05); }
section { display: none; margin-top: 30px; background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
section.active { display: block; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
th { background-color: #0d1b5f; color: white; }
button { background-color: #0d1b5f; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
button:hover { background-color: #ffb6c1; color: #0d47a1; }
canvas { background: #fff; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 15px; margin-top: 15px; }
.low-warning { background: linear-gradient(90deg, rgba(255,230,128,0.2), rgba(255,128,128,0.06)); }
.alert-card { background:#fff4e5; border-left:4px solid #ff7f0e; padding:12px; border-radius:8px; margin-bottom:12px; }
.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
.modal-content { background: #fff; padding: 25px; border-radius: 15px; text-align: center; width: 360px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
.modal-content h3 { margin-bottom: 15px; }
.modal-content input { padding: 10px; width: 80%; border-radius: 8px; border: 1px solid #ddd; text-align: center; font-size: 16px; margin-bottom: 15px; }
#pinFeedback { color:red; font-size:14px; margin-bottom:10px; display:none; }
button.delete-btn { background-color: #d32f2f; color: white; border-radius: 8px; padding: 6px 12px; cursor: pointer; transition: 0.3s; }
button.delete-btn:hover { background-color: #ff6659; color: white; }
</style>

<h1>Admin Dashboard | Buzzard</h1>
<div id="notifications"></div>

<div class="dashboard">
    <div class="card" onclick="showSection('approveReject')">üí∞ Approve / Reject</div>
    <div class="card" onclick="showSection('doneRequests')">üìÅ Done Requests</div>
    <div class="card" onclick="showSection('viewReports')">üìä View Reports</div>
    <div class="card" onclick="showSection('manageBudgets')">üíº Manage Budgets</div>
    <div class="card" onclick="window.location.href='{{ url_for('create_user') }}'">‚ûï Create User</div>
    <div class="card" onclick="showSection('manageUsers')">üë§ Manage Users</div>
    <div class="card" onclick="showSection('changePin')">üîí Change PIN</div>
</div>

<!-- Approve / Reject -->
<section id="approveReject">
    <h2>üí∞ Approve / Reject Requests</h2>
    <table>
        <tr>
            <th>ID</th><th>Department</th><th>Submitted By</th><th>Amount</th><th>Status</th><th>COA</th><th>Receipt</th><th>Action</th>
        </tr>
        {% for req in pending_expenses %}
        <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.department }}</td>
            <td>{{ req.submitted_by }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(req.amount) }}</td>
            <td>{{ req.status or 'Pending' }}</td>
            <td>{{ coa_map.get(req.category, 'N/A') }}</td>
            <td>{% if req.receipt %}<a href="{{ url_for('uploaded_file', filename=req.receipt) }}" target="_blank"><button>View</button></a>{% else %}No Receipt{% endif %}</td>
            <td>
                <form method="post" class="pinForm" action="{{ url_for('approve_expense', expense_id=req.id) }}" style="display:inline;">
                    <button type="button" onclick="openPinModal(this.form,'approve',{{ req.id }})">Approve</button>
                </form>
                <form method="post" class="pinForm" action="{{ url_for('reject_expense', expense_id=req.id) }}" style="display:inline;">
                    <button type="button" onclick="openPinModal(this.form,'reject',{{ req.id }})">Reject</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- Done Requests -->
<section id="doneRequests">
    <h2>üìÅ Done Requests</h2>
    <table>
        <tr><th>ID</th><th>Department</th><th>Submitted By</th><th>Amount</th><th>Status</th><th>Reviewed By</th><th>COA</th><th>Receipt</th></tr>
        {% for req in done_expenses %}
        <tr style="background:{% if req.status=='Approved'%}#e8ffe8{%else%}#ffe8e8{%endif%};">
            <td>{{ req.id }}</td><td>{{ req.department }}</td><td>{{ req.submitted_by }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(req.amount) }}</td>
            <td style="font-weight:bold;color:{% if req.status=='Approved'%}green{%else%}red{%endif%};">{{ req.status }}</td>
            <td>{{ req.reviewed_by or 'N/A' }}</td>
            <td>{{ coa_map.get(req.category, 'N/A') }}</td>
            <td>{% if req.receipt %}<a href="{{ url_for('uploaded_file', filename=req.receipt) }}" target="_blank"><button>View</button></a>{% else %}No Receipt{% endif %}</td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- Reports -->
<section id="viewReports">
    <h2>üìä Expense Reports</h2>
    <canvas id="categoryChart"></canvas>
    <canvas id="deptChart"></canvas>
    <canvas id="weeklyChart"></canvas>
    <canvas id="monthlyChart"></canvas>
</section>

<!-- Budgets -->
<section id="manageBudgets">
    <h2>üíº Manage Budgets</h2>
    <div id="budgetAlerts"></div>
    <canvas id="budgetChart"></canvas>
    <table>
        <tr><th>Department</th><th>Allocated</th><th>Used</th><th>Remaining</th><th>Update</th></tr>
        {% for b in budgets %}
        <tr {% if b.remaining <= 0.15*b.allocated %}class="low-warning"{% endif %}>
            <td>{{ b.department }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.allocated) }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.used) }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.remaining) }}</td>
            <td><button type="button" onclick="openEditBudgetModal('{{ b.department }}', {{ b.allocated }}, {{ b.id }}, {{ b.used }})">Edit</button></td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- Manage Users -->
<section id="manageUsers">
    <h2>üë§ Manage Users</h2>
    <input type="text" id="searchUsers" placeholder="Search users..." onkeyup="filterUsers()">
    <table id="usersTable">
        <thead>
            <tr><th>ID</th><th>Full Name</th><th>Department</th><th>Action</th></tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr>
                <td>{{ u.id }}</td>
                <td style="cursor:pointer;color:#0d47a1;text-decoration:underline;" 
                    onclick="showUserDetails('{{ u.last_name }} {{ u.given_name }} {% if u.middle_name %}{{ u.middle_name }}{% endif %}', 
                                             '{{ u.birthday }}', 
                                             '{{ u.contact_number }}', 
                                             '{{ u.department }}', 
                                             '{{ u.date_created }}')">
                    {{ u.last_name }} {{ u.given_name }} {% if u.middle_name %}{{ u.middle_name }}{% endif %}
                </td>
                <td>{{ u.department or 'N/A' }}</td>
                <td>
                    <a href="{{ url_for('edit_user', user_id=u.id) }}"><button>Edit</button></a>
                    <form method="post" class="pinForm" action="{{ url_for('delete_user', user_id=u.id) }}" style="display:inline;">
                        <button type="button" class="delete-btn" onclick="openPinModal(this.form,'delete',{{ u.id }})">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Change PIN -->
<section id="changePin">
    <h2>üîí Change PIN</h2>
    <form method="POST" action="{{ url_for('change_pin') }}">
        <input type="password" name="current_pin" placeholder="Current PIN" required>
        <input type="password" name="new_pin" placeholder="New PIN" required>
        <input type="password" name="confirm_pin" placeholder="Confirm New PIN" required>
        <br><br>
        <button type="submit">Change PIN</button>
    </form>
</section>

<!-- PIN Modal -->
<div id="pinModal" class="modal">
    <div class="modal-content">
        <h3>Enter Admin PIN to Confirm</h3>
        <input type="password" id="pinInput" placeholder="Enter Admin PIN">
        <div id="pinFeedback"></div>
        <br>
        <button onclick="submitWithPin()">‚úÖ Confirm</button>
        <button onclick="closePinModal()">‚ùå Cancel</button>
    </div>
</div>

<!-- Budget Modal -->
<div id="editBudgetModal" class="modal">
    <div class="modal-content">
        <h3>Edit Budget</h3>
        <form id="editBudgetForm" method="POST">
            <input type="hidden" name="budget_id" id="editBudgetId">
            <input type="hidden" name="department" id="editDept">
            <label>Allocated Amount</label>
            <input type="number" step="0.01" name="allocated" id="editAllocated" required oninput="updateRemaining()">
            <label>Used Amount</label>
            <input type="number" step="0.01" name="used" id="editUsed" required oninput="updateRemaining()">
            <label>Remaining</label>
            <input type="number" step="0.01" name="remaining" id="editRemaining" readonly>
            <br><br>
            <button type="submit">‚úÖ Update</button>
            <button type="button" onclick="closeEditBudgetModal()">‚ùå Cancel</button>
        </form>
    </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal">
    <div class="modal-content">
        <h3>User Details</h3>
        <p><strong>Full Name:</strong> <span id="modalFullName"></span></p>
        <p><strong>Birthday:</strong> <span id="modalBirthday"></span></p>
        <p><strong>Contact Number:</strong> <span id="modalContact"></span></p>
        <p><strong>Department:</strong> <span id="modalDepartment"></span></p>
        <p><strong>Account Created:</strong> <span id="modalCreatedAt"></span></p>
        <br>
        <button onclick="closeUserDetailsModal()">Close</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function showSection(id){ document.querySelectorAll('section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

let targetForm=null;
function openPinModal(form, action, itemId){
    targetForm=form; 
    document.getElementById('pinInput').value=''; 
    document.getElementById('pinFeedback').style.display='none'; 
    document.getElementById('pinModal').style.display='flex';
    let i=form.querySelector('input[name="action"]'); if(!i){ i=document.createElement('input'); i.type='hidden'; i.name='action'; form.appendChild(i);}
    i.value=action;
    let idInput=form.querySelector('input[name="item_id"]'); if(!idInput){ idInput=document.createElement('input'); idInput.type='hidden'; idInput.name='item_id'; form.appendChild(idInput);}
    idInput.value=itemId;
}
function closePinModal(){ document.getElementById('pinModal').style.display='none'; targetForm=null; }
function submitWithPin(){
    if(!targetForm){ closePinModal(); return; }
    const pin=document.getElementById('pinInput').value.trim();
    if(!pin){ document.getElementById('pinFeedback').innerText='‚ùå PIN required'; document.getElementById('pinFeedback').style.display='block'; return; }
    let i=targetForm.querySelector('input[name="pin"]'); if(!i){ i=document.createElement('input'); i.type='hidden'; i.name='pin'; targetForm.appendChild(i);}
    i.value=pin; targetForm.submit(); closePinModal();
}

// Budget Modal
function openEditBudgetModal(dept, allocated, id, used){
    document.getElementById('editBudgetId').value=id;
    document.getElementById('editDept').value=dept;
    document.getElementById('editAllocated').value=allocated;
    document.getElementById('editUsed').value=used;
    document.getElementById('editRemaining').value=(allocated-used).toFixed(2);
    document.getElementById('editBudgetForm').action=`/update_budget/${id}`;
    document.getElementById('editBudgetModal').style.display='flex';
}
function closeEditBudgetModal(){ document.getElementById('editBudgetModal').style.display='none'; }
function updateRemaining(){
    const allocated=parseFloat(document.getElementById('editAllocated').value)||0;
    const used=parseFloat(document.getElementById('editUsed').value)||0;
    document.getElementById('editRemaining').value=(allocated-used).toFixed(2);
}

// User Details
function showUserDetails(fullName,birthday,contact,department,createdAt){
    document.getElementById('modalFullName').innerText=fullName;
    document.getElementById('modalBirthday').innerText=birthday||'N/A';
    document.getElementById('modalContact').innerText=contact||'N/A';
    document.getElementById('modalDepartment').innerText=department||'N/A';
    document.getElementById('modalCreatedAt').innerText=createdAt||'N/A';
    document.getElementById('userDetailsModal').style.display='flex';
}
function closeUserDetailsModal(){ document.getElementById('userDetailsModal').style.display='none'; }

// Charts
function generateColors(n){ const colors=[]; for(let i=0;i<n;i++){ colors.push(`hsl(${(i*360/n)%360} 70% 60%)`);} return colors; }
function createChart(id,type,labels,data){
    return new Chart(document.getElementById(id),{type,data:{labels,datasets:[{label:'Amount',data,data,backgroundColor:generateColors(data.length),borderColor:'black',borderWidth:1}]},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
}
createChart('categoryChart','pie',{{ category_labels|tojson }},{{ category_values|tojson }});
createChart('deptChart','pie',{{ department_labels|tojson }},{{ department_values|tojson }});
createChart('weeklyChart','line',{{ weekly_labels|tojson }},{{ weekly_values|tojson }});
createChart('monthlyChart','line',{{ monthly_labels|tojson }},{{ monthly_values|tojson }});
createChart('budgetChart','pie',[{% for b in budgets %}'{{ b.department }}',{% endfor %}],[{% for b in budgets %}{{ b.remaining }},{% endfor %}]);

// User search
function filterUsers(){
    const input=document.getElementById('searchUsers').value.toLowerCase();
    document.querySelectorAll('#usersTable tbody tr').forEach(row=>{
        row.style.display=row.innerText.toLowerCase().includes(input)?'':'none';
    });
}
</script>
{% endblock %}
