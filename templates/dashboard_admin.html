{% extends "base.html" %}
{% block content %}
<style>
/* Keep your previous CSS unchanged */
body { font-family: "Poppins", sans-serif; background-color: #f7f9fb; padding: 40px; color: black; }
h1,h2,h3,p,a,button,td,th { color: black; }
.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 20px; margin-bottom: 40px; }
.card { background: #fff; border-radius: 15px; box-shadow:0 6px 15px rgba(0,0,0,0.1); text-align:center; padding:25px; cursor:pointer; transition:transform 0.3s, background 0.3s; font-weight:600; }
.card:hover { background:#ffb6c1; transform:scale(1.05); }
section { display:none; margin-top:30px; background:#fff; border-radius:15px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
section.active { display:block; }
table { width:100%; border-collapse: collapse; margin-top:15px; }
th,td { border:1px solid #ddd; padding:12px; text-align:center; }
th { background-color:#0d1b5f; color:white; }
button { background-color:#0d1b5f; color:white; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; transition:0.3s; }
button:hover { background-color:#ffb6c1; color:#0d1b5f; }
a { text-decoration:none; font-weight:600; }
a:hover { color:#ffb6c1; }
canvas { background:#fff; border-radius:15px; box-shadow:0 4px 8px rgba(0,0,0,0.1); padding:15px; margin-top:15px; }
/* PIN Modal */
.modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:25px; border-radius:15px; text-align:center; width:320px; box-shadow:0 5px 20px rgba(0,0,0,0.2); }
.modal-content h3 { margin-bottom:15px; }
.modal-content input { padding:10px; width:80%; border-radius:8px; border:1px solid #ddd; text-align:center; font-size:16px; margin-bottom:15px; }
</style>

<h1>Admin Dashboard | Buzzard</h1>

<div class="dashboard">
    <div class="card" onclick="showSection('approveReject')">üí∞ Approve / Reject</div>
    <div class="card" onclick="showSection('viewReports')">üìä View Reports</div>
    <div class="card" onclick="showSection('manageUsers')">üë§ Manage Users</div>
    <div class="card" onclick="showSection('manageBudgets')">üíº Manage Budgets</div>
    <div class="card" onclick="window.location.href='{{ url_for('create_user') }}'">‚ûï Create User</div>
</div>

<!-- Approve / Reject -->
<section id="approveReject">
    <h2>üí∞ Approve / Reject Requests</h2>
    <table>
        <tr><th>ID</th><th>Department</th><th>Submitted By</th><th>Amount</th><th>Status</th><th>Action</th></tr>
        {% for req in expenses %}
        <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.department }}</td>
            <td>{{ req.submitted_by }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(req.amount) }}</td>
            <td>{{ req.status }}</td>
            <td>
                <form method="post" action="{{ url_for('approve_expense', expense_id=req.id) }}" class="pinForm">
                    <button type="button" onclick="openPinModal(this.form)">Approve</button>
                </form>
                <form method="post" action="{{ url_for('reject_expense', expense_id=req.id) }}" class="pinForm">
                    <button type="button" onclick="openPinModal(this.form)">Reject</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- View Reports -->
<section id="viewReports">
    <h2>üìä Expense Reports</h2>
    <canvas id="categoryChart"></canvas>
    <canvas id="deptChart"></canvas>
    <canvas id="weeklyChart"></canvas>
    <canvas id="monthlyChart"></canvas>
</section>

<!-- Manage Users -->
<section id="manageUsers">
    <h2>üë§ Manage Users (Admin Only)</h2>
    <table>
        <tr><th>ID</th><th>Name</th><th>Role</th><th>Department</th><th>Email</th><th>Action</th></tr>
        {% for user in users %}
        <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.name }}</td>
            <td>{{ user.role }}</td>
            <td>{{ user.department or '-' }}</td>
            <td>{{ user.email or '-' }}</td>
            <td>
                <a href="{{ url_for('edit_user', user_id=user.id) }}"><button>Edit</button></a>
                {% if user.role != 'admin' %}
                <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}" class="pinForm">
                    <button type="button" onclick="openPinModal(this.form)">Delete</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- Manage Budgets -->
<section id="manageBudgets">
    <h2>üíº Manage Budgets</h2>
    <canvas id="budgetChart"></canvas>
    <table>
        <tr><th>Department</th><th>Allocated</th><th>Used</th><th>Remaining</th><th>Update</th></tr>
        {% for b in budgets %}
        <tr>
            <td>{{ b.department }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.allocated) }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.used) }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.remaining) }}</td>
            <td><button>Edit</button></td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- üîí PIN Modal -->
<div id="pinModal" class="modal">
    <div class="modal-content">
        <h3>Enter PIN to Confirm</h3>
        <input type="password" id="pinInput" placeholder="Enter PIN">
        <br>
        <button onclick="submitWithPin()">‚úÖ Confirm</button>
        <button onclick="closePinModal()">‚ùå Cancel</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let targetForm = null;

function showSection(id){
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function openPinModal(form) {
    targetForm = form;
    document.getElementById('pinInput').value = '';
    document.getElementById('pinModal').style.display = 'flex';
}

function closePinModal() {
    document.getElementById('pinModal').style.display = 'none';
    targetForm = null;
}

function submitWithPin() {
    const pin = document.getElementById('pinInput').value.trim();
    if(!targetForm) { alert('‚ùå No action selected'); closePinModal(); return; }

    let input = targetForm.querySelector('input[name="pin"]');
    if(!input){
        input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'pin';
        targetForm.appendChild(input);
    }
    input.value = pin;
    targetForm.submit();
    closePinModal();
}

// Charts (remain unchanged)
new Chart(document.getElementById('categoryChart'), {
    type:'bar',
    data:{labels: {{ category_labels|tojson }}, datasets:[{label:'Approved Amount', data: {{ category_values|tojson }}, backgroundColor:'#0d1b5f'}]},
    options:{responsive:true}
});
new Chart(document.getElementById('deptChart'), {
    type:'bar',
    data:{labels: {{ dept_labels|tojson }}, datasets:[{label:'Department Spending', data: {{ dept_values|tojson }}, backgroundColor:'#ffb6c1'}]},
    options:{responsive:true}
});
new Chart(document.getElementById('weeklyChart'), {
    type:'line',
    data:{labels: {{ weekly_labels|tojson }}, datasets:[{label:'Weekly Expenses', data: {{ weekly_values|tojson }}, borderColor:'#1f77b4', fill:false}]},
    options:{responsive:true}
});
new Chart(document.getElementById('monthlyChart'), {
    type:'line',
    data:{labels: {{ monthly_labels|tojson }}, datasets:[{label:'Monthly Expenses', data: {{ monthly_values|tojson }}, borderColor:'#ff7f0e', fill:false}]},
    options:{responsive:true}
});
new Chart(document.getElementById('budgetChart'), {
    type:'pie',
    data:{
        labels:[{% for b in budgets %}'{{ b.department }}',{% endfor %}],
        datasets:[{data:[{% for b in budgets %}{{ b.remaining }},{% endfor %}], backgroundColor:['#0d1b5f','#ffb6c1','#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd']}]
    },
    options:{plugins:{legend:{position:'bottom'}}}
});
</script>
{% endblock %}
