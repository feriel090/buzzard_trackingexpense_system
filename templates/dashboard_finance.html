{% extends "base.html" %}
{% block content %}
<style>
body { font-family:"Poppins",sans-serif; background:#f7f9fb; padding:40px; color:black; }
h1,h2,p,button,th,td { color:black; }
.dashboard { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-bottom:40px; }
.card { background:#fff; border-radius:15px; box-shadow:0 6px 15px rgba(0,0,0,0.1); text-align:center; padding:25px; cursor:pointer; font-weight:600; transition:0.3s; }
.card:hover { background:#ffb6c1; transform:scale(1.05); }
section { display:none; margin-top:30px; background:#fff; border-radius:15px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
section.active { display:block; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ddd; padding:12px; text-align:center; }
th { background-color:#0d1b5f; color:white; }
button { background-color:#0d1b5f; color:white; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; transition:0.3s; }
button:hover { background-color:#ffb6c1; color:#0d1b5f; }
canvas { background:#fff; border-radius:15px; box-shadow:0 4px 8px rgba(0,0,0,0.1); padding:15px; margin-top:15px; }
.low-warning { background:linear-gradient(90deg, rgba(255,230,128,0.2), rgba(255,128,128,0.06)); }
.alert-card { background:#fff4e5; border-left:4px solid #ff7f0e; padding:12px; border-radius:8px; margin-bottom:12px; }
.modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:25px; border-radius:15px; text-align:center; width:400px; box-shadow:0 5px 20px rgba(0,0,0,0.2); }
.modal-content h3 { margin-bottom:15px; }
.modal-content input { padding:10px; width:90%; border-radius:8px; border:1px solid #ddd; text-align:center; font-size:16px; margin-bottom:15px; }
.modal-content label { display:block; text-align:left; margin-bottom:5px; font-weight:500; }
</style>

<h1>Finance Dashboard | Buzzard</h1>
<div id="notifications"></div>

<div class="dashboard">
    <div class="card" onclick="showSection('approveReject')">üí∞ Approve / Reject</div>
    <div class="card" onclick="showSection('doneRequests')">üìÅ Done Requests</div>
    <div class="card" onclick="showSection('viewReports')">üìä View Reports</div>
    <div class="card" onclick="showSection('manageBudgets')">üíº Manage Budgets</div>
    <div class="card" onclick="window.location.href='{{ url_for('new_expense') }}'">‚ûï Submit Expense</div>
    <div class="card" onclick="showSection('changePin')">üîí Change PIN</div>
    <div class="card" onclick="showSection('resetPassword')">Reset Password</div>
</div>

<!-- Approve / Reject Section -->
<section id="approveReject">
    <h2>üí∞ Approve / Reject Expenses</h2>
    <table>
        <tr>
            <th>ID</th><th>Department</th><th>Submitted By</th><th>Amount</th><th>COA</th><th>Action</th><th>Receipt</th>
        </tr>
        {% for req in pending_expenses if req.submitted_by != current_user.name %}
        <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.department }}</td>
            <td>{{ req.submitted_by }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(req.amount) }}</td>
            <td>{{ req.coa or 'N/A' }}</td>
            <td>
                <!-- Approve Button -->
                <form method="post" action="{{ url_for('approve_expense', expense_id=req.id) }}" style="display:inline;">
                    <button type="button" onclick="openPinModal('approve', {{ req.id }})">Approve</button>
                </form>
                <!-- Reject Button -->
                <form method="post" action="{{ url_for('reject_expense', expense_id=req.id) }}" style="display:inline;">
                    <button type="button" onclick="openPinModal('reject', {{ req.id }})">Reject</button>
                </form>
            </td>
            <!-- Receipt column restored -->
            <td>
                {% if req.receipt %}
                    <a href="{{ url_for('uploaded_file', filename=req.receipt) }}" target="_blank"><button>View</button></a>
                {% else %}
                    No Receipt
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- Change PIN -->
<section id="changePin">
    <h2>üîí Change PIN</h2>
    <form id="changePinForm" method="POST" action="{{ url_for('change_pin') }}">
        <input type="password" name="current_pin" placeholder="Current PIN" required>
        <input type="password" name="new_pin" placeholder="New PIN" required>
        <input type="password" name="confirm_pin" placeholder="Confirm New PIN" required>
        <br><br>
        <button type="submit">Change PIN</button>
    </form>
</section>

<!-- Done Requests Section -->
<section id="doneRequests">
    <h2>üìÅ Done Requests</h2>
    <table>
        <tr><th>ID</th><th>Department</th><th>Submitted By</th><th>Amount</th><th>Status</th><th>Reviewed By</th><th>COA</th><th>Receipt</th></tr>
        {% for req in done_expenses %}
        <tr style="background:{% if req.status=='Approved'%}#e8ffe8{% else %}#ffe8e8{% endif %};">
            <td>{{ req.id }}</td>
            <td>{{ req.department }}</td>
            <td>{{ req.submitted_by }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(req.amount) }}</td>
            <td style="font-weight:bold; color:{% if req.status=='Approved'%}green{% else %}red{% endif %};">{{ req.status|capitalize }}</td>
            <td>{{ req.reviewed_by or 'N/A' }}</td>
            <td>{{ req.coa or 'N/A' }}</td>
            <td>{% if req.receipt %}<a href="{{ url_for('uploaded_file', filename=req.receipt) }}" target="_blank"><button>View</button></a>{% else %}No Receipt{% endif %}</td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- View Reports Section -->
<section id="viewReports">
    <h2>üìä Expense Reports</h2>
    <canvas id="categoryChart"></canvas>
    <canvas id="deptChart"></canvas>
    <canvas id="weeklyChart"></canvas>
    <canvas id="monthlyChart"></canvas>
</section>

<!-- Manage Budgets Section -->
<section id="manageBudgets">
    <h2>üíº Manage Budgets</h2>
    <canvas id="budgetChart"></canvas>
    <table id="budgetsTable">
        <tr><th>Department</th><th>Allocated</th><th>Used</th><th>Remaining</th><th>Edit</th></tr>
        {% for b in budgets if b.department != 'Finance' %}
        <tr data-id="{{ b.id }}" data-allocated="{{ b.allocated }}" data-used="{{ b.used }}">
            <td>{{ b.department }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.allocated) }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.used) }}</td>
            <td>‚Ç±{{ "{:,.2f}".format(b.remaining) }}</td>
            <td>
                <button onclick="openBudgetModal('{{ b.department }}', {{ b.allocated }}, {{ b.used }}, {{ b.id }})">Edit</button>
            </td>
        </tr>
        {% endfor %}
    </table>
</section>

<!-- Reset Password Section -->
<section id="resetPassword">
    <h2>Reset Your Password</h2>
    <form method="POST" action="{{ url_for('reset_password') }}">
        <label>Username</label>
        <input type="text" name="username" value="{{ current_user.name }}" readonly>
        <label>Current Password</label>
        <input type="password" name="current_password" required>
        <label>New Password</label>
        <input type="password" name="new_password" required>
        <button type="submit">Reset Password</button>
    </form>
</section>

<!-- Unified PIN Modal -->
<div id="pinModal" class="modal">
    <div class="modal-content">
        <h3>Enter Your PIN</h3>
        <input type="password" id="pinInput" placeholder="4-digit PIN">
        <br>
        <button onclick="confirmPin()">‚úÖ Confirm</button>
        <button onclick="closePinModal()">‚ùå Cancel</button>
    </div>
</div>


<!-- Budget Modal -->
<div id="budgetModal" class="modal">
    <div class="modal-content">
        <h3>Edit Budget</h3>
        <p id="budgetDept"></p>
        <label>Allocated:</label>
        <input type="number" id="budgetAllocated">
        <label>Used:</label>
        <input type="number" id="budgetUsed">
        <label>Remaining:</label>
        <input type="number" id="budgetRemaining" readonly>
        <br><br>
        <button onclick="saveBudget()">Save</button>
        <button onclick="closeBudgetModal()">Cancel</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Section toggle
function showSection(id){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// PIN modal
let pinAction=null; let expenseId=null;
function openPinModal(action, id=null){ pinAction=action; expenseId=id; document.getElementById('pinInput').value=''; document.getElementById('pinModal').style.display='flex'; }
function closePinModal(){ document.getElementById('pinModal').style.display='none'; pinAction=null; expenseId=null; }
async function confirmPin(){
    const pin=document.getElementById('pinInput').value.trim();
    if(!/^\d{4}$/.test(pin)){ alert('PIN must be 4 digits'); return; }
    if(pinAction==='approve'||pinAction==='reject'){
        const url=`/expense_action/${pinAction}/${expenseId}`;
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin})});
        const data=await res.json(); alert(data.message); location.reload();
    }
    closePinModal();
}

// Budget modal
function openBudgetModal(dept, allocated, used, id){
    document.getElementById('budgetDept').innerText = dept;
    document.getElementById('budgetAllocated').value = allocated;
    document.getElementById('budgetUsed').value = used;
    document.getElementById('budgetRemaining').value = allocated - used;

    const allocatedInput = document.getElementById('budgetAllocated');
    const usedInput = document.getElementById('budgetUsed');

    allocatedInput.oninput = updateRemaining;
    usedInput.oninput = updateRemaining;

    document.getElementById('budgetModal').dataset.id = id;
    document.getElementById('budgetModal').style.display = 'flex';
}
function updateRemaining(){
    const allocated = parseFloat(document.getElementById('budgetAllocated').value) || 0;
    const used = parseFloat(document.getElementById('budgetUsed').value) || 0;
    document.getElementById('budgetRemaining').value = Math.max(0, allocated - used);
}
function closeBudgetModal(){ document.getElementById('budgetModal').style.display = 'none'; }
function saveBudget(){
    const id = document.getElementById('budgetModal').dataset.id;
    const allocated = document.getElementById('budgetAllocated').value;
    const used = document.getElementById('budgetUsed').value;
    fetch(`/update_budget/${id}`, {method:'POST', body:new URLSearchParams({allocated, used})})
        .then(()=> location.reload());
}

// Budget warnings
function checkBudgetWarnings(){
    document.querySelectorAll('#budgetsTable tr[data-id]').forEach(row=>{
        const allocated=parseFloat(row.dataset.allocated)||0;
        const used=parseFloat(row.dataset.used)||0;
        const remaining=Math.max(0, allocated-used);
        const pct=allocated>0 ? (remaining/allocated*100) : 0;
        if(pct<=15){
            row.classList.add('low-warning');
            const div=document.createElement('div');
            div.className='alert-card';
            div.innerHTML=`<strong>‚ö†Ô∏è ${row.children[0].innerText}</strong> only ‚Ç±${remaining.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} left (${pct.toFixed(1)}%)`;
            document.getElementById('notifications').appendChild(div);
        }
    });
}

// Charts
function generateColors(n){ const colors=[]; for(let i=0;i<n;i++){ const h=Math.round((i*360/n)%360); colors.push(`hsl(${h} 70% 60%)`);} return colors; }
function renderChart({id,type='line',labels=[],data=[],label='',colors=[]}){
    return new Chart(document.getElementById(id), {type,data:{labels,datasets:[{label,data,borderColor:colors[0]||'hsl(220 70% 40%)',backgroundColor:colors.length?colors:'transparent',fill:type==='line'?false:true}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}, scales:type==='line'?{y:{beginAtZero:true}}:{}}});
}

// Expense charts
renderChart({id:'categoryChart', labels:{{ charts['category']['labels']|tojson }}, data:{{ charts['category']['data']|tojson }}, label:'Approved Amount'});
renderChart({id:'deptChart', labels:{{ charts['dept']['labels']|tojson }}, data:{{ charts['dept']['data']|tojson }}, label:'Department Spending'});
renderChart({id:'weeklyChart', labels:{{ charts['weekly']['labels']|tojson }}, data:{{ charts['weekly']['data']|tojson }}, label:'Weekly Expenses'});
renderChart({id:'monthlyChart', labels:{{ charts['monthly']['labels']|tojson }}, data:{{ charts['monthly']['data']|tojson }}, label:'Monthly Expenses'});

// Budget chart excluding Finance
const budgetLabels = [{% for b in budgets if b.department != 'Finance' %}'{{ b.department }}',{% endfor %}];
const budgetData = [{% for b in budgets if b.department != 'Finance' %}{{ b.remaining }},{% endfor %}];
renderChart({id:'budgetChart', type:'pie', labels:budgetLabels, data:budgetData, colors:generateColors(budgetLabels.length) });

window.addEventListener('DOMContentLoaded',()=>{ checkBudgetWarnings(); });
</script>
{% endblock %}